import{c as o}from"./@coinbase-DbO_AdsL.js";import{j as m}from"./json-rpc-random-id-DmWAYPg7.js";import{p as v}from"./pify-2zFsNgG8.js";import{c as B,d as g}from"./@metamask-C75uGz2U.js";var L={},l={},a={},w=o&&o.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(a,"__esModule",{value:!0});a.BaseBlockTracker=void 0;const y=w(B),T=1e3,R=(t,e)=>t+e,_=["sync","latest"];class I extends y.default{constructor(e){super(),this._blockResetDuration=e.blockResetDuration||20*T,this._usePastBlocks=e.usePastBlocks||!1,this._currentBlock=null,this._isRunning=!1,this._onNewListener=this._onNewListener.bind(this),this._onRemoveListener=this._onRemoveListener.bind(this),this._resetCurrentBlock=this._resetCurrentBlock.bind(this),this._setupInternalEvents()}async destroy(){this._cancelBlockResetTimeout(),await this._maybeEnd(),super.removeAllListeners()}isRunning(){return this._isRunning}getCurrentBlock(){return this._currentBlock}async getLatestBlock(){return this._currentBlock?this._currentBlock:await new Promise(r=>this.once("latest",r))}removeAllListeners(e){return e?super.removeAllListeners(e):super.removeAllListeners(),this._setupInternalEvents(),this._onRemoveListener(),this}_setupInternalEvents(){this.removeListener("newListener",this._onNewListener),this.removeListener("removeListener",this._onRemoveListener),this.on("newListener",this._onNewListener),this.on("removeListener",this._onRemoveListener)}_onNewListener(e){_.includes(e)&&this._maybeStart()}_onRemoveListener(){this._getBlockTrackerEventCount()>0||this._maybeEnd()}async _maybeStart(){this._isRunning||(this._isRunning=!0,this._cancelBlockResetTimeout(),await this._start(),this.emit("_started"))}async _maybeEnd(){this._isRunning&&(this._isRunning=!1,this._setupBlockResetTimeout(),await this._end(),this.emit("_ended"))}_getBlockTrackerEventCount(){return _.map(e=>this.listenerCount(e)).reduce(R)}_shouldUseNewBlock(e){const r=this._currentBlock;if(!r)return!0;const i=h(e),s=h(r);return this._usePastBlocks&&i<s||i>s}_newPotentialLatest(e){this._shouldUseNewBlock(e)&&this._setCurrentBlock(e)}_setCurrentBlock(e){const r=this._currentBlock;this._currentBlock=e,this.emit("latest",e),this.emit("sync",{oldBlock:r,newBlock:e})}_setupBlockResetTimeout(){this._cancelBlockResetTimeout(),this._blockResetTimeout=setTimeout(this._resetCurrentBlock,this._blockResetDuration),this._blockResetTimeout.unref&&this._blockResetTimeout.unref()}_cancelBlockResetTimeout(){this._blockResetTimeout&&clearTimeout(this._blockResetTimeout)}_resetCurrentBlock(){this._currentBlock=null}}a.BaseBlockTracker=I;function h(t){return Number.parseInt(t,16)}var p={};(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.createModuleLogger=t.projectLogger=void 0;const e=g;Object.defineProperty(t,"createModuleLogger",{enumerable:!0,get:function(){return e.createModuleLogger}}),t.projectLogger=(0,e.createProjectLogger)("eth-block-tracker")})(p);var b=o&&o.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(l,"__esModule",{value:!0});l.PollingBlockTracker=void 0;const P=b(m),j=b(v),E=a,d=p,k=(0,d.createModuleLogger)(d.projectLogger,"polling-block-tracker"),S=(0,P.default)(),C=1e3;class D extends E.BaseBlockTracker{constructor(e={}){var r;if(!e.provider)throw new Error("PollingBlockTracker - no provider specified.");super(Object.assign(Object.assign({},e),{blockResetDuration:(r=e.blockResetDuration)!==null&&r!==void 0?r:e.pollingInterval})),this._provider=e.provider,this._pollingInterval=e.pollingInterval||20*C,this._retryTimeout=e.retryTimeout||this._pollingInterval/10,this._keepEventLoopActive=e.keepEventLoopActive===void 0?!0:e.keepEventLoopActive,this._setSkipCacheFlag=e.setSkipCacheFlag||!1}async checkForLatestBlock(){return await this._updateLatestBlock(),await this.getLatestBlock()}async _start(){this._synchronize()}async _end(){}async _synchronize(){for(var e;this._isRunning;)try{await this._updateLatestBlock();const r=f(this._pollingInterval,!this._keepEventLoopActive);this.emit("_waitingForNextIteration"),await r}catch(r){const i=new Error(`PollingBlockTracker - encountered an error while attempting to update latest block:
${(e=r.stack)!==null&&e!==void 0?e:r}`);try{this.emit("error",i)}catch{console.error(i)}const s=f(this._retryTimeout,!this._keepEventLoopActive);this.emit("_waitingForNextIteration"),await s}}async _updateLatestBlock(){const e=await this._fetchLatestBlock();this._newPotentialLatest(e)}async _fetchLatestBlock(){const e={jsonrpc:"2.0",id:S(),method:"eth_blockNumber",params:[]};this._setSkipCacheFlag&&(e.skipCache=!0),k("Making request",e);const r=await(0,j.default)(i=>this._provider.sendAsync(e,i))();if(k("Got response",r),r.error)throw new Error(`PollingBlockTracker - encountered error fetching block:
${r.error.message}`);return r.result}}l.PollingBlockTracker=D;function f(t,e){return new Promise(r=>{const i=setTimeout(r,t);i.unref&&e&&i.unref()})}var u={},M=o&&o.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(u,"__esModule",{value:!0});u.SubscribeBlockTracker=void 0;const N=M(m),O=a,$=(0,N.default)();class A extends O.BaseBlockTracker{constructor(e={}){if(!e.provider)throw new Error("SubscribeBlockTracker - no provider specified.");super(e),this._provider=e.provider,this._subscriptionId=null}async checkForLatestBlock(){return await this.getLatestBlock()}async _start(){if(this._subscriptionId===void 0||this._subscriptionId===null)try{const e=await this._call("eth_blockNumber");this._subscriptionId=await this._call("eth_subscribe","newHeads"),this._provider.on("data",this._handleSubData.bind(this)),this._newPotentialLatest(e)}catch(e){this.emit("error",e)}}async _end(){if(this._subscriptionId!==null&&this._subscriptionId!==void 0)try{await this._call("eth_unsubscribe",this._subscriptionId),this._subscriptionId=null}catch(e){this.emit("error",e)}}_call(e,...r){return new Promise((i,s)=>{this._provider.sendAsync({id:$(),method:e,params:r,jsonrpc:"2.0"},(n,c)=>{n?s(n):i(c.result)})})}_handleSubData(e,r){var i;r.method==="eth_subscription"&&((i=r.params)===null||i===void 0?void 0:i.subscription)===this._subscriptionId&&this._newPotentialLatest(r.params.result.number)}}u.SubscribeBlockTracker=A;(function(t){var e=o&&o.__createBinding||(Object.create?function(i,s,n,c){c===void 0&&(c=n),Object.defineProperty(i,c,{enumerable:!0,get:function(){return s[n]}})}:function(i,s,n,c){c===void 0&&(c=n),i[c]=s[n]}),r=o&&o.__exportStar||function(i,s){for(var n in i)n!=="default"&&!Object.prototype.hasOwnProperty.call(s,n)&&e(s,i,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(l,t),r(u,t)})(L);export{L as d};
//# sourceMappingURL=eth-block-tracker-p6MLmKNF.js.map
