{"version":3,"file":"async-mutex-CMqhl0c0.js","sources":["../../node_modules/async-mutex/lib/Semaphore.js","../../node_modules/async-mutex/lib/Mutex.js","../../node_modules/async-mutex/lib/withTimeout.js","../../node_modules/async-mutex/lib/index.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tslib_1 = require(\"tslib\");\nvar Semaphore = /** @class */ (function () {\n    function Semaphore(_maxConcurrency) {\n        this._maxConcurrency = _maxConcurrency;\n        this._queue = [];\n        if (_maxConcurrency <= 0) {\n            throw new Error('semaphore must be initialized to a positive value');\n        }\n        this._value = _maxConcurrency;\n    }\n    Semaphore.prototype.acquire = function () {\n        var _this = this;\n        var locked = this.isLocked();\n        var ticket = new Promise(function (r) { return _this._queue.push(r); });\n        if (!locked)\n            this._dispatch();\n        return ticket;\n    };\n    Semaphore.prototype.runExclusive = function (callback) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, value, release;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, this.acquire()];\n                    case 1:\n                        _a = _b.sent(), value = _a[0], release = _a[1];\n                        _b.label = 2;\n                    case 2:\n                        _b.trys.push([2, , 4, 5]);\n                        return [4 /*yield*/, callback(value)];\n                    case 3: return [2 /*return*/, _b.sent()];\n                    case 4:\n                        release();\n                        return [7 /*endfinally*/];\n                    case 5: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Semaphore.prototype.isLocked = function () {\n        return this._value <= 0;\n    };\n    Semaphore.prototype.release = function () {\n        if (this._maxConcurrency > 1) {\n            throw new Error('this method is unavailabel on semaphores with concurrency > 1; use the scoped release returned by acquire instead');\n        }\n        if (this._currentReleaser) {\n            var releaser = this._currentReleaser;\n            this._currentReleaser = undefined;\n            releaser();\n        }\n    };\n    Semaphore.prototype._dispatch = function () {\n        var _this = this;\n        var nextConsumer = this._queue.shift();\n        if (!nextConsumer)\n            return;\n        var released = false;\n        this._currentReleaser = function () {\n            if (released)\n                return;\n            released = true;\n            _this._value++;\n            _this._dispatch();\n        };\n        nextConsumer([this._value--, this._currentReleaser]);\n    };\n    return Semaphore;\n}());\nexports.default = Semaphore;\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tslib_1 = require(\"tslib\");\nvar Semaphore_1 = require(\"./Semaphore\");\nvar Mutex = /** @class */ (function () {\n    function Mutex() {\n        this._semaphore = new Semaphore_1.default(1);\n    }\n    Mutex.prototype.acquire = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a, releaser;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, this._semaphore.acquire()];\n                    case 1:\n                        _a = _b.sent(), releaser = _a[1];\n                        return [2 /*return*/, releaser];\n                }\n            });\n        });\n    };\n    Mutex.prototype.runExclusive = function (callback) {\n        return this._semaphore.runExclusive(function () { return callback(); });\n    };\n    Mutex.prototype.isLocked = function () {\n        return this._semaphore.isLocked();\n    };\n    Mutex.prototype.release = function () {\n        this._semaphore.release();\n    };\n    return Mutex;\n}());\nexports.default = Mutex;\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.withTimeout = void 0;\nvar tslib_1 = require(\"tslib\");\n// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types\nfunction withTimeout(sync, timeout, timeoutError) {\n    var _this = this;\n    if (timeoutError === void 0) { timeoutError = new Error('timeout'); }\n    return {\n        acquire: function () {\n            return new Promise(function (resolve, reject) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var isTimeout, ticket, release;\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            isTimeout = false;\n                            setTimeout(function () {\n                                isTimeout = true;\n                                reject(timeoutError);\n                            }, timeout);\n                            return [4 /*yield*/, sync.acquire()];\n                        case 1:\n                            ticket = _a.sent();\n                            if (isTimeout) {\n                                release = Array.isArray(ticket) ? ticket[1] : ticket;\n                                release();\n                            }\n                            else {\n                                resolve(ticket);\n                            }\n                            return [2 /*return*/];\n                    }\n                });\n            }); });\n        },\n        runExclusive: function (callback) {\n            return tslib_1.__awaiter(this, void 0, void 0, function () {\n                var release, ticket;\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            release = function () { return undefined; };\n                            _a.label = 1;\n                        case 1:\n                            _a.trys.push([1, , 7, 8]);\n                            return [4 /*yield*/, this.acquire()];\n                        case 2:\n                            ticket = _a.sent();\n                            if (!Array.isArray(ticket)) return [3 /*break*/, 4];\n                            release = ticket[1];\n                            return [4 /*yield*/, callback(ticket[0])];\n                        case 3: return [2 /*return*/, _a.sent()];\n                        case 4:\n                            release = ticket;\n                            return [4 /*yield*/, callback()];\n                        case 5: return [2 /*return*/, _a.sent()];\n                        case 6: return [3 /*break*/, 8];\n                        case 7:\n                            release();\n                            return [7 /*endfinally*/];\n                        case 8: return [2 /*return*/];\n                    }\n                });\n            });\n        },\n        release: function () {\n            sync.release();\n        },\n        isLocked: function () { return sync.isLocked(); },\n    };\n}\nexports.withTimeout = withTimeout;\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.withTimeout = exports.Semaphore = exports.Mutex = void 0;\nvar Mutex_1 = require(\"./Mutex\");\nObject.defineProperty(exports, \"Mutex\", { enumerable: true, get: function () { return Mutex_1.default; } });\nvar Semaphore_1 = require(\"./Semaphore\");\nObject.defineProperty(exports, \"Semaphore\", { enumerable: true, get: function () { return Semaphore_1.default; } });\nvar withTimeout_1 = require(\"./withTimeout\");\nObject.defineProperty(exports, \"withTimeout\", { enumerable: true, get: function () { return withTimeout_1.withTimeout; } });\n"],"names":["Semaphore_1","tslib_1","require$$0","Semaphore","_maxConcurrency","_this","locked","ticket","r","callback","_a","value","release","_b","releaser","nextConsumer","released","Mutex_1","require$$1","Mutex","withTimeout_1","withTimeout","sync","timeout","timeoutError","resolve","reject","isTimeout","exports","require$$2"],"mappings":"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","x_google_ignoreList":[0,1,2,3]}